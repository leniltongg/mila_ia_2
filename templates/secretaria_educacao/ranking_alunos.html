{% extends "secretaria_educacao/base_secretaria_educacao.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Ranking de Alunos</h2>
        <div class="col-md-4 position-relative">
            <input type="text" class="form-control" id="escolaFilter" placeholder="Buscar escola..." autocomplete="off">
            <div id="escolasDropdown" class="position-absolute w-100 bg-white border rounded-bottom shadow-sm" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
            </div>
        </div>
    </div>

    <!-- Abas para Ranking Geral e por Disciplina -->
    <ul class="nav nav-tabs mb-3" id="rankingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral" type="button" role="tab" aria-controls="geral" aria-selected="true">
                Ranking Geral
            </button>
        </li>
        {% for disciplina in disciplinas %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="disciplina-{{ loop.index }}-tab" data-bs-toggle="tab" data-bs-target="#disciplina-{{ loop.index }}" type="button" role="tab" aria-controls="disciplina-{{ loop.index }}" aria-selected="false">
                {{ disciplina.nome }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <!-- Abas para Anos Escolares -->
    <ul class="nav nav-tabs nav-tabs-secondary mb-3" id="anosEscolares" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" onclick="filtrarPorAno('todos')">
                Todos os Anos
            </button>
        </li>
        {% for ano in anos_escolares %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" onclick="filtrarPorAno('{{ ano }}')">
                {{ ano }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <!-- Filtro de Turma -->
    <div class="mb-3">
        <select class="form-select" id="turmaFilter" disabled>
            <option value="">Selecione uma turma...</option>
        </select>
    </div>

    <!-- Conteúdo das Abas -->
    <div class="tab-content" id="rankingTabsContent">
        <!-- Ranking Geral -->
        <div class="tab-pane fade show active" id="geral" role="tabpanel" aria-labelledby="geral-tab">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Posição</th>
                            <th>Nome</th>
                            <th>Ano Escolar</th>
                            <th>Escola</th>
                            <th>Turma</th>
                            <th>Média Geral</th>
                            <th>Total de Simulados</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBodyGeral">
                        {% for aluno in ranking_geral %}
                        <tr data-ano="{{ aluno.ano_escolar }}" data-escola="{{ aluno.escola }}" data-turma="{{ aluno.turma }}">
                            <td>{{ loop.index }}º</td>
                            <td>{{ aluno.nome }}</td>
                            <td>{{ aluno.ano_escolar }}</td>
                            <td>{{ aluno.escola }}</td>
                            <td>{{ aluno.turma }}</td>
                            <td>{{ "%.1f"|format(aluno.media_geral) }}%</td>
                            <td>{{ aluno.total_simulados }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ranking por Disciplina -->
        {% for disciplina in disciplinas %}
        <div class="tab-pane fade" id="disciplina-{{ loop.index }}" role="tabpanel" aria-labelledby="disciplina-{{ loop.index }}-tab">
            {% if disciplina.nome in ranking_disciplinas %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Posição</th>
                            <th>Nome</th>
                            <th>Ano Escolar</th>
                            <th>Escola</th>
                            <th>Turma</th>
                            <th>Média na Disciplina</th>
                            <th>Total de Simulados</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody-{{ loop.index }}">
                        {% for aluno in ranking_disciplinas[disciplina.nome]['todos'] %}
                        <tr data-ano="{{ aluno.ano_escolar }}" data-escola="{{ aluno.escola }}" data-turma="{{ aluno.turma }}">
                            <td>{{ loop.index }}º</td>
                            <td>{{ aluno.nome }}</td>
                            <td>{{ aluno.ano_escolar }}</td>
                            <td>{{ aluno.escola }}</td>
                            <td>{{ aluno.turma }}</td>
                            <td>{{ "%.1f"|format(aluno.media_disciplina) }}%</td>
                            <td>{{ aluno.total_simulados }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mt-3">
                Nenhum dado disponível para esta disciplina.
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Lista global de escolas
const todasEscolas = {{ escolas|tojson|safe }};
console.log("Escolas carregadas:", todasEscolas);

function filtrarPorAno(anoSelecionado) {
    // Atualiza os botões ativos
    document.querySelectorAll('#anosEscolares .nav-link').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.trim() === (anoSelecionado === 'todos' ? 'Todos os Anos' : anoSelecionado)) {
            btn.classList.add('active');
        }
    });

    // Atualiza as turmas disponíveis se tiver escola selecionada
    const escola = document.getElementById('escolaFilter').value;
    if (escola && anoSelecionado !== 'todos') {
        atualizarTurmas();
    } else {
        // Desabilita e limpa o select de turmas
        const turmaSelect = document.getElementById('turmaFilter');
        turmaSelect.disabled = true;
        turmaSelect.innerHTML = '<option value="">Selecione uma turma...</option>';
    }

    // Filtra todas as tabelas
    document.querySelectorAll('.tab-pane tbody').forEach(tbody => {
        const rows = tbody.getElementsByTagName('tr');
        let posicao = 1;

        for (let row of rows) {
            const anoAluno = row.getAttribute('data-ano');
            const escolaValue = document.getElementById('escolaFilter').value.toLowerCase();
            const escolaAluno = row.getAttribute('data-escola').toLowerCase();
            const turmaValue = document.getElementById('turmaFilter').value;
            const turmaAluno = row.getAttribute('data-turma');
            
            const matchAno = anoSelecionado === 'todos' || anoSelecionado === anoAluno;
            const matchEscola = !escolaValue || escolaAluno.includes(escolaValue);
            const matchTurma = !turmaValue || turmaValue === turmaAluno;
            
            if (matchAno && matchEscola && matchTurma) {
                row.style.display = '';
                row.getElementsByTagName('td')[0].textContent = posicao + 'º';
                posicao++;
            } else {
                row.style.display = 'none';
            }
        }
    });
}

function buscarEscolas(texto) {
    const dropdown = document.getElementById('escolasDropdown');
    console.log("Buscando escolas com texto:", texto);
    
    if (!texto) {
        dropdown.style.display = 'none';
        return;
    }

    const escolasFiltradas = todasEscolas.filter(escola => 
        escola.toLowerCase().includes(texto.toLowerCase())
    );

    if (escolasFiltradas.length > 0) {
        dropdown.innerHTML = escolasFiltradas
            .map(escola => `<div class="dropdown-item p-2 cursor-pointer hover-bg-light" onclick="selecionarEscola('${escola}')">${escola}</div>`)
            .join('');
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

function selecionarEscola(escola) {
    document.getElementById('escolaFilter').value = escola;
    document.getElementById('escolasDropdown').style.display = 'none';
    const anoSelecionado = document.querySelector('#anosEscolares .nav-link.active').textContent.trim();
    
    // Só atualiza as turmas se não for "Todos os Anos"
    if (anoSelecionado !== 'Todos os Anos') {
        atualizarTurmas();
    } else {
        // Se for "Todos os Anos", desabilita o select de turmas
        const turmaSelect = document.getElementById('turmaFilter');
        turmaSelect.disabled = true;
        turmaSelect.innerHTML = '<option value="">Selecione uma turma...</option>';
    }
    
    filtrarPorAno(anoSelecionado === 'Todos os Anos' ? 'todos' : anoSelecionado);
}

function atualizarTurmas() {
    const escola = document.getElementById('escolaFilter').value;
    const anoSelecionado = document.querySelector('#anosEscolares .nav-link.active').textContent.trim();
    const turmaSelect = document.getElementById('turmaFilter');
    
    if (!escola || anoSelecionado === 'Todos os Anos') {
        turmaSelect.disabled = true;
        turmaSelect.innerHTML = '<option value="">Selecione uma turma...</option>';
        return;
    }

    console.log('Buscando turmas para:', escola, anoSelecionado);

    // Buscar turmas da escola e ano selecionados
    fetch(`/secretaria_educacao/buscar-turmas?escola=${encodeURIComponent(escola)}&ano_escolar=${encodeURIComponent(anoSelecionado)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na resposta do servidor');
            }
            return response.json();
        })
        .then(data => {
            console.log('Turmas recebidas:', data);
            
            if (data.error) {
                console.error('Erro ao buscar turmas:', data.error);
                return;
            }

            turmaSelect.innerHTML = '<option value="">Todas as turmas</option>';
            data.turmas.forEach(turma => {
                const option = document.createElement('option');
                option.value = turma;
                option.textContent = turma;
                turmaSelect.appendChild(option);
            });
            turmaSelect.disabled = false;
        })
        .catch(error => {
            console.error('Erro ao buscar turmas:', error);
            turmaSelect.disabled = true;
            turmaSelect.innerHTML = '<option value="">Erro ao carregar turmas</option>';
        });
}

// Event listeners
document.getElementById('escolaFilter').addEventListener('input', function(e) {
    buscarEscolas(e.target.value);
    // Se o campo de escola for limpo, desabilita o select de turmas
    if (!e.target.value) {
        const turmaSelect = document.getElementById('turmaFilter');
        turmaSelect.disabled = true;
        turmaSelect.innerHTML = '<option value="">Selecione uma turma...</option>';
    }
});

document.getElementById('turmaFilter').addEventListener('change', function() {
    const anoSelecionado = document.querySelector('#anosEscolares .nav-link.active').textContent.trim();
    filtrarPorAno(anoSelecionado === 'Todos os Anos' ? 'todos' : anoSelecionado);
});

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    const escolaFilter = document.getElementById('escolaFilter');
    const anoSelecionado = document.querySelector('#anosEscolares .nav-link.active').textContent.trim();
    if (escolaFilter.value && anoSelecionado !== 'Todos os Anos') {
        atualizarTurmas();
    }
});
</script>
{% endblock %}
