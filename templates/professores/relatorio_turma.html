{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Cabeçalho -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">{{ turma.serie }} - Turma {{ turma.nome }}</h2>
                    <p class="text-muted mb-0">{{ turma.escola }}</p>
                </div>
                <div>
                    <button onclick="window.print()" class="btn btn-outline-primary">
                        <i class="fas fa-print me-2"></i>Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas Gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Total de Alunos</h6>
                    <h2 class="mb-0">{{ total_alunos }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Média da Turma</h6>
                    <h2 class="mb-0">{{ "%.1f"|format(media_turma) if media_turma else "0.0" }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Melhor Desempenho</h6>
                    <h2 class="mb-0">{{ "%.1f"|format(melhores_alunos[0].media_geral) if melhores_alunos else "0.0" }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted">Total de Simulados</h6>
                    <h2 class="mb-0">{{ alunos[0].total_simulados if alunos else 0 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    {% if grafico_distribuicao and grafico_medias %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Distribuição de Notas</h5>
                    <img src="data:image/png;base64,{{ grafico_distribuicao }}" class="img-fluid" alt="Distribuição de Notas">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Médias Individuais</h5>
                    <img src="data:image/png;base64,{{ grafico_medias }}" class="img-fluid" alt="Médias Individuais">
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="text-muted">Não há dados suficientes para gerar os gráficos</h5>
                    <p class="mb-0">Aguarde até que os alunos realizem alguns simulados.</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Destaques -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Melhores Desempenhos</h5>
                    <div class="list-group list-group-flush">
                        {% for aluno in melhores_alunos %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">{{ aluno.nome }}</h6>
                                    <small class="text-muted">{{ aluno.total_simulados }} simulados realizados</small>
                                </div>
                                <h5><span class="badge bg-success">{{ "%.1f"|format(aluno.media_geral) }}%</span></h5>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Alunos que Precisam de Atenção</h5>
                    <div class="list-group list-group-flush">
                        {% for aluno in alunos_atencao %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">{{ aluno.nome }}</h6>
                                    <small class="text-muted">{{ aluno.total_simulados }} simulados realizados</small>
                                </div>
                                <h5><span class="badge bg-danger">{{ "%.1f"|format(aluno.media_geral) }}%</span></h5>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Alunos -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Lista Completa de Alunos</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Simulados</th>
                            <th>Média Geral</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for aluno in alunos %}
                        <tr>
                            <td>{{ aluno.nome }}</td>
                            <td>{{ aluno.email }}</td>
                            <td>{{ aluno.total_simulados }}</td>
                            <td>
                                <span class="badge {% if aluno.media_geral >= 70 %}bg-success{% elif aluno.media_geral >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ "%.1f"|format(aluno.media_geral) }}%
                                </span>
                            </td>
                            <td>
                                <a href="/portal_professores/relatorio_aluno/{{ aluno.id }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-chart-line me-1"></i>Ver Relatório
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Data do Relatório -->
    <div class="text-muted text-end mt-3">
        <small>Relatório gerado em {{ now.strftime('%d/%m/%Y às %H:%M') }}</small>
    </div>
</div>

<style>
@media print {
    .btn-outline-primary {
        display: none;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .table {
        font-size: 12px;
    }
    
    .badge {
        border: 1px solid #ddd !important;
    }
}
</style>
{% endblock %}
