{% extends "professores/base_professores.html" %}

{% block head %}
<style>
    /* Card styles */
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1rem;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,.125);
        padding: 1rem;
    }
    .card-header h5 {
        margin: 0;
        color: #333;
        font-weight: 600;
    }
    
    /* Questões styles */
    .questao-row {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: white;
        transition: all 0.2s;
    }
    .questao-row:hover {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transform: translateY(-1px);
    }
    .questao-row.dragging {
        opacity: 0.5;
        background-color: #f8f9fa;
    }
    
    /* Áreas de questões */
    #questoes-disponiveis {
        max-height: 600px;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
    }
    #questoes-selecionadas {
        min-height: 200px;
        border: 2px dashed #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    #questoes-selecionadas.drag-over {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    /* Botões e ações */
    .btn-add-questao {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.25rem;
    }
    .btn-action {
        color: #0d6efd;
        cursor: pointer;
        padding: 0.25rem;
        margin: 0 0.25rem;
        transition: color 0.2s;
    }
    .btn-action:hover {
        color: #0a58ca;
    }
    .btn-remove {
        color: #dc3545;
    }
    .btn-remove:hover {
        color: #bb2d3b;
    }
    
    /* Resumo do simulado */
    .resumo-simulado {
        background-color: #fff;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    .resumo-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    .resumo-item:last-child {
        border-bottom: none;
    }
    
    /* Feedback visual */
    .feedback {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1050;
    }
    .questao-preview {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
    }
    .questao-preview:hover {
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block title %}Criar Simulado{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Formulário e Resumo do Simulado -->
        <div class="col-md-3">
            <!-- Dados do Simulado -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-file-earmark-text me-2"></i>Dados do Simulado</h5>
                </div>
                <div class="card-body">
                    <form id="simulado-form">
                        <div class="mb-3">
                            <label for="serie_id" class="form-label">Série</label>
                            <select class="form-select" id="serie_id" required>
                                <option value="">Selecione...</option>
                                {% for serie in series %}
                                <option value="{{ serie.id }}">{{ serie.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="mes_id" class="form-label">Mês</label>
                            <select class="form-select" id="mes_id" required>
                                <option value="">Selecione...</option>
                                {% for mes in meses %}
                                <option value="{{ mes.id }}">{{ mes.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="disciplina_id" class="form-label">Disciplina</label>
                            <select class="form-select" id="disciplina_id" required>
                                <option value="">Selecione...</option>
                                {% for disciplina in disciplinas %}
                                <option value="{{ disciplina.id }}">{{ disciplina.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-save me-2"></i>Salvar Simulado
                        </button>
                    </form>
                </div>
            </div>

            <!-- Resumo do Simulado -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-list-check me-2"></i>Resumo do Simulado</h5>
                </div>
                <div class="card-body">
                    <div class="resumo-simulado">
                        <div class="resumo-item">
                            <span>Total de Questões:</span>
                            <strong id="total-questoes">0</strong>
                        </div>
                        <div class="resumo-item">
                            <span>Série:</span>
                            <strong id="resumo-serie">-</strong>
                        </div>
                        <div class="resumo-item">
                            <span>Disciplina:</span>
                            <strong id="resumo-disciplina">-</strong>
                        </div>
                        <div class="resumo-item">
                            <span>Mês:</span>
                            <strong id="resumo-mes">-</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Banco de Questões -->
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-journal-text me-2"></i>Banco de Questões</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <form id="pesquisa-form" class="mb-3">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label for="filtro-serie" class="form-label">Série</label>
                                <select class="form-select" id="filtro-serie">
                                    <option value="">Todas</option>
                                    {% for serie in series %}
                                    <option value="{{ serie.id }}">{{ serie.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtro-disciplina" class="form-label">Disciplina</label>
                                <select class="form-select" id="filtro-disciplina">
                                    <option value="">Todas</option>
                                    {% for disciplina in disciplinas %}
                                    <option value="{{ disciplina.id }}">{{ disciplina.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtro-assunto" class="form-label">Assunto</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="filtro-assunto" placeholder="Digite...">
                                    <button class="btn btn-primary" type="submit">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Lista de Questões -->
                    <div id="questoes-disponiveis">
                        <!-- Questões serão inseridas aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Questões Selecionadas -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-check2-square me-2"></i>Questões Selecionadas</h5>
                </div>
                <div class="card-body">
                    <div id="questoes-selecionadas">
                        <!-- Questões selecionadas serão inseridas aqui -->
                        <div class="text-center text-muted" id="empty-state">
                            <i class="bi bi-arrow-left-circle" style="font-size: 2rem;"></i>
                            <p class="mt-2">Arraste questões do banco ou clique no botão adicionar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Visualização -->
<div class="modal fade" id="modalVisualizarQuestao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Visualizar Questão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modal-questao">
                <!-- Conteúdo da questão será inserido aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnAdicionarQuestaoModal">
                    <i class="bi bi-plus-circle me-2"></i>Adicionar ao Simulado
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let questaoAtualModal = null;
const questoesSelecionadas = new Set();

document.addEventListener('DOMContentLoaded', function() {
    const pesquisaForm = document.getElementById('pesquisa-form');
    const simuladoForm = document.getElementById('simulado-form');
    const questoesDisponiveis = document.getElementById('questoes-disponiveis');
    const questoesSelecionadasDiv = document.getElementById('questoes-selecionadas');
    
    // Atualizar resumo quando os campos mudarem
    document.getElementById('serie_id').addEventListener('change', atualizarResumo);
    document.getElementById('disciplina_id').addEventListener('change', function() {
        atualizarResumo();
        buscarQuestoes();
    });
    document.getElementById('mes_id').addEventListener('change', atualizarResumo);

    // Event listeners for filter elements
    document.getElementById('filtro-serie').addEventListener('change', buscarQuestoes);
    document.getElementById('filtro-disciplina').addEventListener('change', buscarQuestoes);
    document.getElementById('filtro-assunto').addEventListener('change', buscarQuestoes);

    // Initial setup
    setupDragAndDrop();
    
    // Form submission handler
    document.getElementById('simulado-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (questoesSelecionadas.size === 0) {
            mostrarFeedback('Selecione pelo menos uma questão', 'warning');
            return;
        }
        
        const formData = {
            serie_id: document.getElementById('serie_id').value,
            disciplina_id: document.getElementById('disciplina_id').value,
            mes_id: document.getElementById('mes_id').value,
            questoes: Array.from(questoesSelecionadas)
        };
        
        try {
            const response = await fetch('/professores/salvar-simulado', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                mostrarFeedback('Simulado criado com sucesso!', 'success');
                setTimeout(() => {
                    window.location.href = '/professores/simulados';
                }, 1500);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            mostrarFeedback(error.message, 'danger');
        }
    });
});

function mostrarFeedback(mensagem, tipo) {
    const div = document.createElement('div');
    div.className = `alert alert-${tipo} alert-dismissible fade show feedback`;
    div.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

function atualizarResumo() {
    const serie = document.getElementById('serie_id');
    const disciplina = document.getElementById('disciplina_id');
    const mes = document.getElementById('mes_id');
    
    document.getElementById('resumo-serie').textContent = 
        serie.options[serie.selectedIndex]?.text || '-';
    document.getElementById('resumo-disciplina').textContent = 
        disciplina.options[disciplina.selectedIndex]?.text || '-';
    document.getElementById('resumo-mes').textContent = 
        mes.options[mes.selectedIndex]?.text || '-';
    document.getElementById('total-questoes').textContent = 
        questoesSelecionadas.size;
}

async function buscarQuestoes() {
    const serie = document.getElementById('filtro-serie').value;
    const disciplina = document.getElementById('filtro-disciplina').value;
    const assunto = document.getElementById('filtro-assunto').value;
    
    try {
        const response = await fetch(`/professores/buscar-questoes?serie_id=${serie}&disciplina_id=${disciplina}&assunto=${assunto}`);
        const questoes = await response.json();
        
        const questoesDisponiveis = document.getElementById('questoes-disponiveis');
        questoesDisponiveis.innerHTML = questoes.map(questao => {
            // Stringify questao object only once and escape quotes properly
            const questaoJSON = JSON.stringify(questao).replace(/"/g, '&quot;');
            return `
                <div class="questao-row" draggable="true" data-questao='${questaoJSON}'>
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="questao-texto">${questao.questao.substring(0, 100)}...</div>
                            <small class="text-muted">
                                ${questao.disciplina_nome} | ${questao.serie_nome} | ${questao.assunto}
                            </small>
                        </div>
                        <div>
                            <i class="bi bi-eye btn-action" onclick="visualizarQuestao(${questaoJSON})"></i>
                            <i class="bi bi-plus-circle btn-action" onclick="adicionarQuestao(${questaoJSON})"></i>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        setupDragAndDrop();
    } catch (error) {
        console.error('Erro ao buscar questões:', error);
        mostrarFeedback('Erro ao buscar questões', 'danger');
    }
}

function visualizarQuestao(questao) {
    questaoAtualModal = questao;
    const modalBody = document.querySelector('.modal-questao');
    
    modalBody.innerHTML = `
        <div class="questao-preview">
            <div class="questao-header">
                <div class="questao-info">
                    <strong>Disciplina:</strong> ${questao.disciplina_nome} |
                    <strong>Série:</strong> ${questao.serie_nome} |
                    <strong>Assunto:</strong> ${questao.assunto}
                </div>
            </div>
            <div class="questao-texto mb-3">${questao.questao}</div>
            <div class="alternativas">
                <div class="alternativa">A) ${questao.alternativa_a}</div>
                <div class="alternativa">B) ${questao.alternativa_b}</div>
                <div class="alternativa">C) ${questao.alternativa_c}</div>
                <div class="alternativa">D) ${questao.alternativa_d}</div>
                ${questao.alternativa_e ? `<div class="alternativa">E) ${questao.alternativa_e}</div>` : ''}
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('modalVisualizarQuestao'));
    modal.show();
}

function adicionarQuestao(questao) {
    if (questoesSelecionadas.has(questao.id)) {
        mostrarFeedback('Questão já adicionada', 'warning');
        return;
    }
    
    questoesSelecionadas.add(questao.id);
    const questoesSelecionadasDiv = document.getElementById('questoes-selecionadas');
    const emptyState = document.getElementById('empty-state');
    
    if (emptyState) emptyState.remove();
    
    const questaoElement = document.createElement('div');
    questaoElement.className = 'questao-row';
    questaoElement.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="questao-texto">${questao.questao.substring(0, 100)}...</div>
                <small class="text-muted">
                    ${questao.disciplina_nome} | ${questao.serie_nome} | ${questao.assunto}
                </small>
            </div>
            <div>
                <i class="bi bi-eye btn-action" onclick="visualizarQuestao(${JSON.stringify(questao).replace(/"/g, '&quot;')})"></i>
                <i class="bi bi-x-circle btn-action btn-remove" onclick="removerQuestao(${questao.id}, this.parentElement.parentElement.parentElement)"></i>
            </div>
        </div>
    `;
    
    questoesSelecionadasDiv.appendChild(questaoElement);
    atualizarResumo();
    
    // Fechar modal se estiver aberto
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalVisualizarQuestao'));
    if (modal) modal.hide();
    
    mostrarFeedback('Questão adicionada com sucesso', 'success');
}

function removerQuestao(questaoId, element) {
    questoesSelecionadas.delete(questaoId);
    element.remove();
    atualizarResumo();
    
    // Mostrar empty state se não houver questões
    if (questoesSelecionadas.size === 0) {
        const questoesSelecionadasDiv = document.getElementById('questoes-selecionadas');
        questoesSelecionadasDiv.innerHTML = `
            <div class="text-center text-muted" id="empty-state">
                <i class="bi bi-arrow-left-circle" style="font-size: 2rem;"></i>
                <p class="mt-2">Arraste questões do banco ou clique no botão adicionar</p>
            </div>
        `;
    }
    
    mostrarFeedback('Questão removida', 'info');
}

function setupDragAndDrop() {
    const questoesRows = document.querySelectorAll('.questao-row');
    const questoesSelecionadasDiv = document.getElementById('questoes-selecionadas');
    
    questoesRows.forEach(row => {
        row.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.questao);
        });
        
        row.addEventListener('dragend', function() {
            this.classList.remove('dragging');
        });
    });
    
    questoesSelecionadasDiv.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    });
    
    questoesSelecionadasDiv.addEventListener('dragleave', function() {
        this.classList.remove('drag-over');
    });
    
    questoesSelecionadasDiv.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const questao = JSON.parse(e.dataTransfer.getData('text/plain'));
        adicionarQuestao(questao);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const disciplinaSelect = document.getElementById('disciplina_id');
    
    disciplinaSelect.addEventListener('change', function() {
        buscarQuestoes();
    });
    
    // Setup inicial do drag and drop
    setupDragAndDrop();
});

function visualizarQuestao(questaoId) {
    // Implementar modal para visualizar detalhes da questão
    // TODO
}
</script>
{% endblock %}
